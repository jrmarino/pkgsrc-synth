--- pkgtools/pkg/Makefile.orig	2016-11-14 20:39:43 UTC
+++ pkgtools/pkg/Makefile
@@ -1,7 +1,6 @@
 # $NetBSD: Makefile,v 1.14 2016/11/14 19:38:11 marino Exp $
 
-DISTNAME=	pkg-1.8.7
-PKGREVISION=	7
+DISTNAME=	pkg-1.9.99.2
 CATEGORIES=	pkgtools
 MASTER_SITES=	http://files.etoilebsd.net/pkg/
 EXTRACT_SUFX=	.tar.xz
@@ -92,6 +91,13 @@ SUBST_FILES.vuxml=	libpkg/pkg_audit.c
 SUBST_SED.vuxml=	-e "s|https://vuxml.FreeBSD.org/freebsd|http://muscles.dragonflybsd.org/pkgsrc-vuxml/reports|"
 SUBST_MESSAGE.vuxml=	Direct audit reports to Pkgsrc vuxml
 
+# These next two can removed with version 1.9.99.3+
+SUBST_CLASSES+=		sbuftype
+SUBST_STAGE.sbuftype=	post-patch
+SUBST_FILES.sbuftype=	external/libsbuf/sys/sbuf.h
+SUBST_SED.sbuftype=	-e "s|_types.h|types.h|"
+SUBST_MESSAGE.sbuftype=	gitfix 043e8f6 (sbuf.h)
+
 SUBST_CLASSES+=		ldhints
 SUBST_STAGE.ldhints=	post-patch
 SUBST_FILES.ldhints=	libpkg/private/ldconfig.h libpkg/elfhints.c
@@ -148,6 +154,29 @@ PKGNG_DBDIR?=	${PKG_DBDIR}
 PKGNG_DBDIR?=	/var/db/pkgng
 .endif
 
+# Disable checksum when pkg(8) is not installed and PKG_FORMAT is "pkgng".
+# This format requires pkg to be present for the "info" capability used
+# extensively, including for checksums.  It's bootstrap chicken/egg scenario.
+# This is here to allow someone to build and reinstall pkg(8) when a new
+# version comes out.
+
+# Note that pkgtools/pkgng_admin and pkgtools/bootstrap-mk-files must be
+# present before pkg(8) can be rebuilt.  There's is seemingly no way to
+# enforce this requirement because pkgng PKG_FORMAT requires pkgng_admin
+# to function properly.
+
+.if ${PKG_FORMAT:Mpkgng} && !exists(${PKG_CMD})
+NO_CHECKSUM=			yes
+SKIP_LICENSE_CHECK=		yes
+ALLOW_VULNERABLE_PACKAGES=	yes
+TOOLS_IGNORE.digest=		# block dependency on digest
+STATIC_PKG=			${DESTDIR}${LOCALBASE}/sbin/pkg-static
+PKG_ADD_CMD=			${SETENV} PKG_DBDIR=${PKG_DBDIR:Q} \
+				INSTALL_AS_USER=yes ${STATIC_PKG} add
+PKG_CREATE=			${SETENV} PKG_DBDIR=${PKG_DBDIR:Q} \
+				${STATIC_PKG} create
+.endif
+
 .if ${OPSYS} != "FreeBSD" && ${OPSYS} != "DragonFly" && ${OPSYS} != "NetBSD"
 .include "../../archivers/libarchive/buildlink3.mk"
 .endif
