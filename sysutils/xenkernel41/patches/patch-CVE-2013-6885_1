$NetBSD: patch-CVE-2013-6885_1,v 1.2 2014/02/20 17:37:25 drochner Exp $

http://lists.xenproject.org/archives/html/xen-devel/2013-12/msg00235.html
http://lists.xenproject.org/archives/html/xen-devel/2014-02/msg01800.html

--- xen/arch/x86/cpu/amd.c.orig	2013-09-10 06:42:18.000000000 +0000
+++ xen/arch/x86/cpu/amd.c
@@ -661,6 +661,20 @@ static void __devinit init_amd(struct cp
 	}
 #endif
 
+	if (c->x86 == 0x16 && c->x86_model <= 0xf) {
+		rdmsrl(MSR_AMD64_LS_CFG, value);
+		if (!(value & (1 << 15))) {
+			static bool_t warned;
+
+			if (c == &boot_cpu_data || opt_cpu_info ||
+			    !test_and_set_bool(warned))
+				printk(KERN_WARNING
+				       "CPU%u: Applying workaround for erratum 793\n",
+				       smp_processor_id());
+			wrmsrl(MSR_AMD64_LS_CFG, value | (1 << 15));
+		}
+	}
+
 	if (c->x86 == 0x10) {
 		/*
 		 * On family 10h BIOS may not have properly enabled WC+
